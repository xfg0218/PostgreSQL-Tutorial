**摘要** ：在本教程中，你将学习如何使用 `PostgreSQL` 自连接来比较同一表中的行。

# `PostgreSQL` 自连接简介

 `PostgreSQL` 自连接是一种强大的技术，它允许您使用 [ `内连接` ](./Inner-Join.md)、[ `左连接` ](./Left-Join.md) 或 [ `右连接` ](./Right-Join.md) 将一个表与自身连接起来。

 由于一个表与自身连接，这种连接技术被称为自连接。当你想要比较同一个表中的行时，自连接技术会很有帮助。

 `PostgreSQL` 不允许在同一条 `SQL` 语句中多次使用同一张表。如果这样做，`PostgreSQL` 会报语法错误。

 要在一个语句中多次使用同一张表，必须为该表分配不同的别名。在这种情况下，`PostgreSQL` 会将这些别名视为不同的表。

 以下是自连接的语法：

 ```sql
 SELECT
  column1,
  column2,
  column3
FROM
  table_name t1
  INNER JOIN table_name t2 ON t1.column1 = t2.column2;
```

在该语法中：

- 首先，在 `FROM` 子句中指定一个表名，并使用别名 `t1` 。
- 其次，在 `INNER JOIN` 子句中提供相同的表名，并使用别名 `t2` 。
- 第三，使用条件来匹配表中的行。

除了 `INNER JOIN` 子句，你还可以在 `SELECT` 语句中使用 `LEFT JOIN` 或 `RIGHT JOIN` 子句。

# `PostgreSQL` 自连接示例

让我们来看一些使用 `PostgreSQL` 自连接的例子。

## 创建示例表

首先，创建一个新表，名为 `categories` ：

```sql
CREATE TABLE categories (
  category_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  parent_id INT,
  FOREIGN KEY (parent_id) REFERENCES categories (category_id) ON DELETE CASCADE
);
```

在 `categories` 表中，`parent_id` 是一个 外键列，它引用 主键列 `category_id`。

顶级类别在 `parent_id` 列中会有 `NULL` 。

子类别在 `parent_id` 列中的值将与现有行的 `category_id` 列中的某个值相同。

其次，向 `categories` 表中插入数据：

```sql
INSERT INTO
  categories (category_id, name, parent_id)
VALUES
  (1, 'Electronics', NULL),
  (2, 'Mobile Devices', 1),
  (3, 'Smartphones', 2),
  (4, 'Tablets', 2),
  (5, 'Accessories', 2),
  (6, 'Wearables', 2),
  (7, 'Home Entertainment', 1),
  (8, 'Televisions', 7),
  (9, 'Audio Systems', 7),
  (10, 'Computers', 1),
  (11, 'Laptops', 10),
  (12, 'Desktops', 10)
RETURNING *;
```

输出：

```sql
 category_id |        name        | parent_id
-------------+--------------------+-----------
           1 | Electronics        |      NULL
           2 | Mobile Devices     |         1
           3 | Smartphones        |         2
           4 | Tablets            |         2
           5 | Accessories        |         2
           6 | Wearables          |         2
           7 | Home Entertainment |         1
           8 | Televisions        |         7
           9 | Audio Systems      |         7
          10 | Computers          |         1
          11 | Laptops            |        10
          12 | Desktops           |        10
```

# 使用内连接的 `PostgreSQL` 自连接

以下语句使用 `INNER JOIN` 来选择类别及其父类别：

```sql
SELECT
  c.name category,
  p.name parent
FROM
  categories c
  INNER JOIN categories p ON c.parent_id = p.category_id;
```

输出：

```sql
      category      |       parent
--------------------+--------------------
 Mobile Devices     | Electronics
 Smartphones        | Mobile Devices
 Tablets            | Mobile Devices
 Accessories        | Mobile Devices
 Wearables          | Mobile Devices
 Home Entertainment | Electronics
 Televisions        | Home Entertainment
 Audio Systems      | Home Entertainment
 Computers          | Electronics
 Laptops            | Computers
 Desktops           | Computers
```

输出结果没有显示顶级类别，该类别具有 `parent_id`  `NULL` 。要包含顶级类别，你需要使用 `LEFT JOIN` 来执行自连接。

# 使用左连接的 `PostgreSQL` 自连接

以下语句使用 `LEFT JOIN` 来选择类别及其父类别，包括顶级类别：

```sql
SELECT
  c.name category,
  p.name parent
FROM
  categories c
  LEFT JOIN categories p ON c.parent_id = p.category_id;
```

输出：

```sql
      category      |       parent
--------------------+--------------------
 Electronics        | NULL
 Mobile Devices     | Electronics
 Smartphones        | Mobile Devices
 Tablets            | Mobile Devices
 Accessories        | Mobile Devices
 Wearables          | Mobile Devices
 Home Entertainment | Electronics
 Televisions        | Home Entertainment
 Audio Systems      | Home Entertainment
 Computers          | Electronics
 Laptops            | Computers
 Desktops           | Computers
```

# 总结

- 自连接是指一个表与自身进行的连接。
- 当你需要比较同一表中的行时，可以使用自连接。